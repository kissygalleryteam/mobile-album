/*!build time : 2014-01-07 7:13:37 PM*/
KISSY.add("gallery/mobile-album/1.0/core/pc-mouse",function(a,b,c){function d(b){this.box=b.box,this.config=b,this.livingImg=null||this.box.one("img"),this.touchstartStatus={matrix:[0,0,0,0,0,0,0],distance:0,points:new Array},this.ddAction={left:!1,right:!1,top:!1,bottom:!1},this.ddPrevPoint=null,this.touchType=null,void 0==a.UA.mobile?this._bindEventPC():this._bindEvent(),this.test()}function e(a){var b="-webkit-transform";if(""==a.css(b)&&(b="transform"),""==a.css(b))return[1,0,0,1,0,0];for(var c=a.css(b).match(/matrix\((.*)\)/)[1].split(","),d=0;d<c.length;++d)c[d]=parseFloat(c[d]);return c}var f=b.all,g={test:function(){},freeze:function(){},unfreeze:function(){},initTouchstartStatus:function(){var a=this;a.livingImg=a.box.one("img"),a.touchstartStatus.matrix=e(a.livingImg)},setDDAction:function(a,b){a.left>b.left?(this.ddAction.left=!0,this.ddAction.right=!1):a.left<b.left?(this.ddAction.left=!1,this.ddAction.right=!0):(this.ddAction.left=!1,this.ddAction.right=!1),a.top>b.top?(this.ddAction.top=!0,this.ddAction.bottom=!1):a.top<b.top?(this.ddAction.top=!1,this.ddAction.bottom=!0):(this.ddAction.top=!1,this.ddAction.bottom=!1)},_bindEventPC:function(){var a=this;a.box.on("mousedown",function(b){0==b.button&&"IMG"==b.target.tagName.toUpperCase()&&(a.initTouchstartStatus(),a.handleMousedown(b))}),a.box.on("mousewheel DOMMouseScroll",a.handleMousewheel,a)},handleMousedown:function(a){a.halt();var b=this;b.moveStartPoint={left:a.pageX,top:a.pageY},b.ddMouseMask=f('<div style="z-index: 999999;position: fixed;left:0;top:0;width: 100%;height: 100%;cursor: move;"></div>'),b.ddMouseMask.appendTo(f(document.body)),f(document).on("mousemove",b.handleMousemove,b),f(document).on("mouseup",b.handleMouseup,b)},handleMousemove:function(b){b.halt();var c=this;if(1!=c.isFreeze){var d={left:b.pageX,top:b.pageY},e={left:d.left-c.moveStartPoint.left,top:d.top-c.moveStartPoint.top},g=a.clone(c.touchstartStatus.matrix);g[4]+=e.left,g[5]+=e.top,f(document).fire("dd-mouse",{matrix:g})}},handleMouseup:function(){var a=this;a.ddMouseMask.remove(),delete a.ddMouseMask,f(document).fire("dd-mouse-end"),f(document).detach("mousemove",a.handleMousemove,a),f(document).detach("mouseup",a.handleMouseup,a)},handleMousewheel:function(b){var c=this;if("IMG"==b.target.tagName.toUpperCase()&&(b.halt(),1!=c.isFreeze)){this.initTouchstartStatus();var d="";"windows"==a.UA.os?b.deltaY>0?d=1.1:b.deltaY<0&&(d=.9):/mac/.test(a.UA.os)?b.deltaY<0?d=0-b.deltaY+1:b.deltaY>0&&(d=1-b.deltaY):d=1;var e={left:b.clientX-c.touchstartStatus.matrix[4],top:b.clientY-c.touchstartStatus.matrix[5]},g=c.resetMatrixByScaleAndOrigin(d,e,c.touchstartStatus.matrix);f(document).fire("d_wheel",{matrix:g})}},resetMatrixByScaleAndOrigin:function(b,c,d){var e=a.clone(d);return e[0]=e[3]=b*d[0],e[4]=-1*c.left*(b-1)+d[4],e[5]=-1*c.top*(b-1)+d[5],e}};return a.extend(d,c,g),d},{requires:["node","base"]}),KISSY.add("gallery/mobile-album/1.0/core/gesture",function(a,b,c,d){function e(b){this.box=b.box,this.config=b,this.config.listIdx=0,this.livingImg=null||this.box.one("img"),this.touchstartStatus={matrix:[0,0,0,0,0,0,0],distance:0,points:new Array,time:0},this.boxOffset={left:0,top:0},this.ddAction={left:!1,right:!1,top:!1,bottom:!1},this.ddPrevPoint=null,this.pinchPrevPoint=new Array(2),this.touchType=null,void 0==a.UA.mobile?new d(b):this._bindEvent(),this.test()}function f(a){var b="-webkit-transform";if(""==a.css(b)&&(b="transform"),""==a.css(b))return[1,0,0,1,0,0];for(var c=a.css(b).match(/matrix\((.*)\)/)[1].split(","),d=0;d<c.length;++d)c[d]=parseFloat(c[d]);return c}function g(a){var b=a[0],c=a[1];return Math.sqrt((b.left-c.left)*(b.left-c.left)+(b.top-c.top)*(b.top-c.top))}var h=b.all,i={test:function(){},setBoxOffset:function(a){this.boxOffset=a},freeze:function(){},unfreeze:function(){},initTouchstartStatus:function(){var a=this;a.livingImg=a.box.all("img").item(a.config.listIdx),a.touchstartStatus.matrix=f(a.livingImg)},_bindEvent:function(){var a=this;a.box.on("touchstart",function(b){"IMG"==b.target.tagName.toUpperCase()&&(b.touches&&1==b.touches.length?(a.box.fire("touchend",b),a.touchType="dd",a.handleDDStart(b)):b.touches&&2==b.touches.length&&(h(document).fire("touchend",b),a.touchType="pinch",a.handlePinchStart(b)))}),a.box.on("touchend",function(b){"pinch"==a.touchType?a.handlePinchEnd(b):"dd"==a.touchType})},handleDDStart:function(a){a.halt();var b=this;b.initTouchstartStatus();var c=new Array(2);c[0]={left:a.touches[0].pageX,top:a.touches[0].pageY},b.touchstartStatus.points=c,b.touchstartStatus.time=0,b.ddPrevPoint=c[0],b.fire("dd-start",{matrix:b.touchstartStatus.matrix}),b.box.on("touchmove",b.handleDDIng,b),b.box.on("touchend",b.handleDDEnd,b)},handleDDIng:function(b){if(b.touches&&1==b.touches.length){b.halt();var c=this;if("pinch"!=c.touchType){var d=new Array(2);d[0]={left:b.touches[0].pageX,top:b.touches[0].pageY};var e={left:d[0].left-c.touchstartStatus.points[0].left,top:d[0].top-c.touchstartStatus.points[0].top},f=a.clone(c.touchstartStatus.matrix);f[4]+=e.left,f[5]+=e.top,c.fire("dding",{matrix:f,d:e,interval_d:{left:d[0].left-c.ddPrevPoint.left,top:d[0].top-c.ddPrevPoint.top}}),c.ddPrevPoint=d[0]}}},handleDDEnd:function(){var a=this;return a.box.detach("touchmove",a.handleDDIng,a),a.box.detach("touchend",a.handleDDEnd,a),"dd"!=a.touchType?!1:(a.touchType=null,a.fire("dd-end"),void 0)},handlePinchStart:function(a){a.halt();var b=this;b.fire("pinch-start"),b.initTouchstartStatus();for(var c=new Array(2),d=0;d<a.touches.length;++d)c[d]={left:a.touches[d].pageX-b.touchstartStatus.matrix[4]-b.boxOffset.left,top:a.touches[d].pageY-b.touchstartStatus.matrix[5]-b.boxOffset.top};b.touchstartStatus.points=c,b.touchstartStatus.distance=g(c),b.pinchPrevPoint=c,h(document).on("touchmove",b.handlePinching,b),h(document).on("touchend",b.handlePinchEnd,b)},handlePinching:function(a){var b=this;if("pinch"==b.touchType&&a.touches&&2==a.touches.length){a.halt();for(var c=new Array(2),d=0;d<a.touches.length;++d)c[d]={left:a.touches[d].pageX-b.touchstartStatus.matrix[4]-b.boxOffset.left,top:a.touches[d].pageY-b.touchstartStatus.matrix[5]-b.boxOffset.top};var e=g([b.touchstartStatus.points[0],c[1]]),f=g(c),h=e/b.touchstartStatus.distance,i=f/e,j=b.pinchForOnePointMove(b.touchstartStatus.points[1],c[1],h,b.touchstartStatus.matrix),k=b.pinchForOnePointMove(b.touchstartStatus.points[0],c[0],i,j);b.fire("pinching",{matrix:k}),b.pinchPrevPoint=c}},handlePinchEnd:function(a){var b=this;a.touches&&0==a.touches.length&&(b.touchType=null,h(document).detach("touchmove",b.handlePinching,b),h(document).detach("touchend",b.handlePinchEnd,b),b.fire("pinch-end"))},pinchForOnePointMove:function(a,b,c,d){var e=[0,0,0,0,0,0];return e[0]=e[3]=d[0]*c,e[4]=parseInt(d[4]-a.left*c+b.left),e[5]=parseInt(d[5]-a.top*c+b.top),e}};return a.extend(e,c,i),e},{requires:["node","base","./pc-mouse"]}),KISSY.add("gallery/mobile-album/1.0/wakeup-popup/index",function(a,b,c){function d(){this.msgPanelHelp={curScrollTop:0,timeout:null},this.isLive=!1}var e=b.all,f={wakeup:function(){1!=this.isLive&&(this.isLive=!0,this.wakeupMsgPanel(),this.msgPanelTouchend())},sleep:function(){this.isLive=!1,this.sleepMsgPanel()},wakeupMsgPanel:function(){var a=this;a.msgPanelHelp.curScrollTop=document.body.scrollTop,document.body.scrollTop=0,e(document).on("touchstart",a.msgPanelTouchstart,a)},msgPanelTouchstart:function(){var a=this;e(document).on("touchend",a.msgPanelTouchend,a)},msgPanelTouchend:function(){var a=this;a.msgPanelHelp.timeout&&clearTimeout(a.msgPanelHelp),a.msgPanelHelp.timeout=setTimeout(function(){document.body.scrollTop=0},100)},sleepMsgPanel:function(){var a=this;setTimeout(function(){document.body.scrollTop=a.msgPanelHelp.curScrollTop},110),e(document).detach("touchstart",a.msgPanelTouchstart,a),e(document).detach("touchend",a.msgPanelTouchend,a)}};return a.extend(d,c,f),d},{requires:["node","base"]}),KISSY.add("gallery/mobile-album/1.0/index",function(a,b,c,d){function e(a){var b=this,a=a||{box:g("#J_PinchBox"),boxWrap:g("#J_PinchBoxWrap")};b.box=a.box,b.boxWrap=a.boxWrap,b.config=a,b.albumRange={width:document.documentElement.clientWidth,height:document.documentElement.clientHeight},b.albumInfo={data:a.data||[],idx:a.cIdx||0,albumItems:[]},b.focusItemInfo={img:null,overflowRange:{initTop:0,initLeft:0}},b.showingBorders={left:0,right:0},b.boxBeginMatrix=new Array(6),b.imgBeginMatrix=new Array(6),b.gesture=new c(a),b.wakeupPopup=new d,b.bindEvent()}function f(a){var b="-webkit-transform";if(""==a.css(b)&&(b="transform"),""==a.css(b))return[1,0,0,1,0,0];for(var c=a.css(b).match(/matrix\((.*)\)/)[1].split(","),d=0;d<c.length;++d)c[d]=parseFloat(c[d]);return c}var g=a.all,h={hide:function(){var a=this;a.boxWrap.hide(),a.box.html(""),a.wakeupPopup.sleep()},data:function(a){this.albumInfo.data=a},init:function(){var a=this;a.boxWrap.show(),a.fire("show"),a.initAlbumPanel(),a.wakeupPopup.wakeup()},setIndex:function(a){this.albumInfo.idx=a},initFocusItemInfo:function(){var a=this;a.focusItemInfo.img=a.box.all("img").item(a.albumInfo.idx)},bindEvent:function(){var a=this,b=null;a.gesture.on("pinch-start",function(){var c=f(a.box);a.gesture.setBoxOffset({left:c[4],top:c[5]}),a.initFocusItemInfo(),b&&clearTimeout(b),a.box.removeClass("img-slide")}).on("pinching",function(b){{var c=a.albumInfo.albumItems[a.albumInfo.idx];f(a.box)}a.box.removeClass("img-slide"),c.css("-webkit-transform","matrix( "+b.matrix.join(",")+" )")}).on("pinch-end",function(){var c=a.albumInfo.albumItems[a.albumInfo.idx];a.box.addClass("img-slide"),b&&clearTimeout(b),b=setTimeout(function(){a.box.removeClass("img-slide")},500);var d=f(c),e=f(a.box),g=a.slideToRange2(e,d);c.css("-webkit-transform","matrix( "+g.matrix.join(",")+")"),a.box.css("-webkit-transform","matrix("+g.boxMatrix.join(",")+")"),setTimeout(function(){a.gesture.fire("dd-end",{noReplace:!0})},600),console.log("pinch-end")}),a.gesture.on("dd-start",function(b){a.initFocusItemInfo(),a.boxBeginMatrix=f(a.box),a.imgBeginMatrix=b.matrix,a.box.removeClass("anim").removeClass("img-slide")}).on("dding",function(b){var c=a.albumInfo.albumItems[a.albumInfo.idx],d=f(c),e=f(a.box);e[4]=0==a.albumInfo.idx&&b.d.left>0||a.albumInfo.idx==a.albumInfo.albumItems.length-1&&b.d.left<0?a.boxBeginMatrix[4]+b.d.left/2:a.boxBeginMatrix[4]+b.d.left,d[0]>1&&(d[5]=a.imgBeginMatrix[5]+b.d.top),a.box.css("-webkit-transform","matrix( "+e.join(",")+" )"),c.css("-webkit-transform","matrix("+d.join(",")+")")}).on("dd-end",function(c){a.box.addClass("anim").addClass("img-slide"),b=setTimeout(function(){a.box.removeClass("anim").removeClass("img-slide")},500);var d=a.albumInfo.albumItems[a.albumInfo.idx],e=f(d),g=f(a.box),h=g[4]-a.boxBeginMatrix[4];if(c.noReplace===!0);else if(a.needReplaceShowingImg(h,e))return;var i=a.slideToRange(g,e);d.css("-webkit-transform","matrix("+i.matrix.join(",")+")"),a.box.css("-webkit-transform","matrix("+i.boxMatrix.join(",")+")"),console.log("dd-end")}),g(document).on("dd-mouse d_wheel",function(b){a.target=a.box.all("img").item(a.albumInfo.idx),a.target.css("-webkit-transition","none"),a.target.css("-webkit-transform","matrix( "+b.matrix.join(",")+" )")})},initAlbumPanel:function(){var a=this;a.setTrigger(),a.renderImages(),a.gesture.config.listIdx=a.albumInfo.idx},setTrigger:function(){var a=this;a.albumInfo.data.length>1?(a.boxWrap.one(".J_SlidePinchTrigger").html(new Array(a.albumInfo.data.length+1).join("*").replace(/\*/g,"<li></li>")),a.boxWrap.one(".J_SlidePinchTrigger").children("li").item(a.albumInfo.idx).addClass("current")):a.boxWrap.one(".J_SlidePinchTrigger").html("")},renderImages:function(){var a=this,b=a.albumInfo.data,c=a.albumInfo.idx;a.albumInfo.albumItems=[];for(var d=0;d<b.length;++d){var e=g('<img src="'+b[d].miniSrc+'"/>');a.albumInfo.albumItems.push(e),a.box.append(e),a.imageAdapterRange(d,e,!1),d==a.albumInfo.idx&&a.imageAdapterRange(d,e,!0)}var f=[1,0,0,1,0,0];f[4]=0-c*a.albumRange.width*1.2,a.box.css("-webkit-transform","matrix("+f.join(",")+")")},offsetAlbumImages:function(){for(var a=this,b=a.albumInfo.data,c=a.albumInfo.idx,d=0;d<b.length;++d)d!=c?a.imageAdapterRange(d,a.albumInfo.albumItems[d],!1):a.imageAdapterRange(d,a.albumInfo.albumItems[d],!0)},imageAdapterRange:function(a,b,c){var d=this,e=d.albumInfo.data;if(c===!0&&"true"!==b.attr("data-origin-loaded")){var f=new Image;f.onload=function(){b.attr("src",e[a].originSrc).attr("data-origin-loaded","true"),setTimeout(function(){d.resetImagePosition({width:b.prop("offsetWidth"),height:b.prop("offsetHeight")},b,a)},600)},f.src=e[a].originSrc}d.resetImagePosition({width:e[a].size.width,height:e[a].size.height},b,a)},resetImagePosition:function(a,b,c){var d=this,e=[1,0,0,1,0,0];e[4]=d.albumRange.width*c*1.2;var g="",h="",i=0,j=0;if(a.width/a.height>=d.albumRange.width/d.albumRange.height?(g="100%",j=(d.albumRange.height-a.height*d.albumRange.width/a.width)/2):(h="100%",i=(d.albumRange.width-a.width*d.albumRange.height/a.height)/2),e[4]+=c<d.albumInfo.idx?i-Math.abs(d.showingBorders.left):c>d.albumInfo.idx?i+Math.abs(d.showingBorders.right):i,0!=d.showingBorders.left||0!=d.showingBorders.right){var k=f(d.box);e[4]+=0-k[4]-d.albumRange.width*d.albumInfo.idx*1.2}e[5]+=j,b.css("width",g).css("height",h).css("-webkit-transform","matrix("+e.join(",")+")"),d.albumInfo.data[c].coo={left:i,top:j},d.albumInfo.data[c].size=a,d.albumInfo.data[c].initPos={left:i,top:j}},needReplaceShowingImg:function(a,b){var c=this;if(c.albumInfo.albumItems.length<=1)return!1;var d=c.albumRange.width;if(Math.abs(a)<d/2)return!1;{var e=1.2*c.albumRange.width*c.albumInfo.idx,g=(c.albumInfo.albumItems[c.albumInfo.idx],c.albumInfo.data[c.albumInfo.idx]),h=f(c.box),i=h[4]+e;c.albumInfo.data[c.albumInfo.idx].size}return i-c.showingBorders.left>=d/2?c.albumInfo.idx-1<0?!1:(c._prev(),!0):g.size.width*b[0]+b[4]+h[4]-2*e<=d/2?c.albumInfo.idx+1>=c.albumInfo.data.length?!1:(c._next(),!0):!1},_prev:function(){var a=this;--a.albumInfo.idx,a.albumInfo.idx<0&&(a.albumInfo.idx=a.albumInfo.data.length-1);var b=[1,0,0,1,0,0];b[4]=0-a.albumInfo.idx*a.albumRange.width*1.2,a.box.css("-webkit-transform","matrix("+b.join(",")+")"),a.setTrigger(),a.gesture.config.listIdx=a.albumInfo.idx,a.devideBorders({left:0,right:0})},_next:function(){var a=this;++a.albumInfo.idx,a.albumInfo.idx>=a.albumInfo.data.length&&(a.albumInfo.idx=0);var b=[1,0,0,1,0,0];b[4]=0-a.albumInfo.idx*a.albumRange.width*1.2,a.box.css("-webkit-transform","matrix("+b.join(",")+")"),a.setTrigger(),a.gesture.config.listIdx=a.albumInfo.idx,a.devideBorders({left:0,right:0})},slideToRange:function(a,b){var c=this,d=(c.albumInfo.albumItems[c.albumInfo.idx],c.albumInfo.data[c.albumInfo.idx]),e=c.albumRange.width*c.albumInfo.idx*1.2;return d.size.width*b[0]<=c.albumRange.width?(a[4]=0-c.albumInfo.idx*c.albumRange.width*1.2,b[0]=b[3]=1,b[4]=e+d.coo.left,b[5]=d.coo.top):b[4]+a[4]>0?a[4]=0-b[4]:d.size.width*b[0]+b[4]+a[4]<c.albumRange.width&&(a[4]=c.albumRange.width-d.size.width*b[0]-b[4]),d.size.height*b[0]<=c.albumRange.height?b[5]=(c.albumRange.height-d.size.height*b[0])/2:b[5]>0?b[5]=0:b[5]<c.albumRange.height-d.size.height*b[0]&&(b[5]=c.albumRange.height-d.size.height*b[0]),{boxMatrix:a,matrix:b}},slideToRange2:function(a,b){var c=this,d=(c.albumInfo.albumItems[c.albumInfo.idx],c.albumInfo.data[c.albumInfo.idx]),e=c.albumRange.width*c.albumInfo.idx*1.2,f={left:0,right:0};return b[0]<1?(b[0]=b[3]=1,b[4]=e+d.coo.left,b[5]=d.coo.top):b[0]*d.size.width<=c.albumRange.width?b[4]=0-(b[0]-1)*d.size.width/2+e+d.coo.left:b[0]*d.size.width>c.albumRange.width&&(b[4]+a[4]>0?b[4]=0-a[4]:b[4]+a[4]<c.albumRange.width-d.size.width*b[0]&&(b[4]=c.albumRange.width-d.size.width*b[0]-a[4]),f={left:Math.abs(b[4]+a[4]),right:Math.abs(b[0]*d.size.width-c.albumRange.width-Math.abs(a[4]+b[4]))}),c.devideBorders(f),{boxMatrix:a,matrix:b}},devideBorders:function(a){var b=this;b.showingBorders=a,b.offsetAlbumImages()}};return a.extend(e,b,h),e},{requires:["base","./core/gesture","./wakeup-popup/index","./assets/mobile-album.css"]});